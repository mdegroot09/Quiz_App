<script>

window.addEventListener('load', runGetQuizzes())

function runGetQuizzes(){
  // Get data from spreadsheet 
  google.script.run
  // if successful, display the data 
  .withSuccessHandler(function(res){
    console.log(res)
    document.quiz = res
    document.active = 0
    showQuestion(res, 0)
  })
  // if error
  .withFailureHandler(function(err){
    console.log("error occured", err);
  })
  .getQuizzes()
}

function showQuestion(quiz, i){

  // update active num
  document.active = i
  
  // update question num on UI
  document.getElementById('questionActive').innerText = i + 1
  document.getElementById('questionTotal').innerText = quiz.length

  var questionObj = quiz[i]
  console.log('showQuestion() questionObj:')
  console.log(questionObj)
  var question = document.getElementById('question')
  var optionA = document.getElementById('optionA')
  var optionB = document.getElementById('optionB')
  var optionC = document.getElementById('optionC')
  var optionD = document.getElementById('optionD')
  
  // get correct option element
  var idCorrect = questionObj.idCorrect
  
  // update text for question and options 
  question.innerText = questionObj.question
  optionA.innerText = 'a) ' + questionObj.optionA
  optionB.innerText = 'b) ' + questionObj.optionB
  optionC.innerText = 'c) ' + questionObj.optionC
  optionD.innerText = 'd) ' + questionObj.optionD
  
  resetQuestionStyling(quiz[i])
}

function resetQuestionStyling(question){
  var optionA = document.getElementById('optionA')
  var optionB = document.getElementById('optionB')
  var optionC = document.getElementById('optionC')
  var optionD = document.getElementById('optionD')
  var idCorrect = question.idCorrect
  var correct = document.getElementById(idCorrect)
  
  // if choice was previously made, register choice
  if (question.choice) {
    return registerChoice(question.choice, idCorrect)
  }
  
  // add click functions, styling if no choice has been made
  else {
    // update option onclicks
    optionA.onclick = function(){registerChoice('optionA', idCorrect)}
    optionB.onclick = function(){registerChoice('optionB', idCorrect)}
    optionC.onclick = function(){registerChoice('optionC', idCorrect)}
    optionD.onclick = function(){registerChoice('optionD', idCorrect)}
    
    // update option styling
    optionA.style.color = '#596163'
    optionB.style.color = '#596163'
    optionC.style.color = '#596163'
    optionD.style.color = '#596163'
    
    hideArrows()
    document.getElementById('shotclock').innerText = 24
    document.getElementById('result').innerText = ''
    return startShotclock()
  }
}

function registerChoice(id, idCorrect){
  var eChosen = document.getElementById(id)
  var eCorrect = document.getElementById(idCorrect)
  var result = document.getElementById('result')
  var shotclock = document.getElementById('shotclock')
  var checkmark = document.getElementById('checkmark')
  var xImg = document.getElementById('xImg')
  
  stopShotclock()
  
  // show correct styling
  if (id == idCorrect){
    eChosen.style.color = '#00dec0' // teal
    result.style.color = '#00dec0' // teal
    result.innerText = 'Correct'
    shotclock.style.display = 'none'
    xImg.style.display = 'none'
    checkmark.style.display = 'flex'
  }
  
  // show incorrect styling
  else {
    eCorrect.style.color = '#00dec0' // teal
    eChosen.style.color = 'rgb(253, 150, 150)' // red
    result.style.color = 'rgb(253, 150, 150)' // red
    shotclock.style.display = 'none'
    checkmark.style.display = 'none'
    xImg.style.display = 'flex'
    
    if (id == 'noAnswer'){
      result.innerText = 'Out of Time'
    }
    else {
      result.innerText = 'Incorrect'
    }
  }
  
  var i = document.active
  var quiz = document.quiz
  quiz[i].choice = id
  console.log('quiz question updated:')
  console.log(quiz[i])
  
  runAddChoice(id, i)
  makeGray(id, idCorrect)
  showArrows(quiz, i)
}

function makeGray(id, idCorrect){
  var options = ['optionA', 'optionB', 'optionC', 'optionD']

  // make other options gray and disable all onclicks
  options.forEach(function(a){
    var e = document.getElementById(a)
    if (id != a && idCorrect != a){
      e.style.color = '#dfdfdf'
    }
    e.onclick = ''
  })
}

function hideArrows(){
  document.getElementById('backArrow').style.display = 'none'
  document.getElementById('fwdArrow').style.display = 'none'
}

function showArrows(quiz, i){
  // quit function if active num is outside range
  if (i < 0 || (!i && i != 0)){
    return (document.active = 0)
  }
  else if (i >= quiz.length){
    return (document.active = (quiz.length - 1))
  }
  else if (i == (quiz.length - 1)){
    document.getElementById('fwdArrow').style.display = 'none'
    
    if (quiz.length > 1){
      document.getElementById('backArrow').style.display = 'block'
    }
    else {
      document.getElementById('backArrow').style.display = 'none'
    }
  }
  else if (i == 0){
    document.getElementById('backArrow').style.display = 'none'
    
    if (quiz.length > 1){
      document.getElementById('fwdArrow').style.display = 'block'
    }
    else {
      document.getElementById('fwdArrow').style.display = 'none'
    }
  }
  else {
    document.getElementById('backArrow').style.display = 'block'
    document.getElementById('fwdArrow').style.display = 'block'
  }
}

function startShotclock(){
  var shotclock = document.getElementById('shotclock')
  var checkmark = document.getElementById('checkmark')
  var xImg = document.getElementById('xImg')

  // show shotclock, hide images
  checkmark.style.display = 'none'
  xImg.style.display = 'none'
  shotclock.style.display = 'block'

  document.shotclock = (
    setInterval(function(){
      shotclockNum = shotclock.innerText * 1
      shotclockNum -= 1
      
      if (shotclockNum < 0){
        return outOfTime()
      }
      
      shotclock.innerText = shotclockNum
    }, 1000)
  )
}

function stopShotclock(){
  clearInterval(document.shotclock)
}

function outOfTime(){
  document.getElementById('shotclock').innerText = 0
  stopShotclock()
  
  var quiz = document.quiz
  var i = document.active
  registerChoice('noAnswer', quiz[i].idCorrect)
}

function runAddChoice(choice, active){
  var data = {
    choice: choice,
    active: active
  }
  
  // Get data from spreadsheet 
  google.script.run
  // if successful, display the data 
  .withSuccessHandler(function(res){
    console.log('Spreadsheet updated')
  })
  // if error
  .withFailureHandler(function(err){
    console.log("error occured", err);
  })
  .addChoice(data)
}

</script>